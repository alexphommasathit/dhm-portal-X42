# Policy Document Embedding Edge Function

This Supabase Edge Function generates vector embeddings for policy document chunks using OpenAI's text-embedding-ada-002 model.

## Features

- Generates embeddings for text chunks using OpenAI's API
- Stores embeddings in the Supabase database using pgvector
- Batched processing to avoid API rate limits
- RBAC security with admin-only access
- HIPAA compliance considerations with OpenAI Organization ID header
- Detailed error handling and partial success capabilities

## Requirements

This function requires the following:

1. A Supabase project with pgvector extension enabled
2. An OpenAI API key with access to embeddings
3. A `policy_chunks` table with a `vector(1536)` column for embeddings
4. Pre-chunked document text (generated by the policy-parser function)

## Environment Variables

The function requires these environment variables set in your Supabase project:

```
OPENAI_API_KEY=sk-your-openai-api-key
OPENAI_ORG_ID=org-your-organization-id  # For BAA/HIPAA compliance
```

## Deployment

To deploy this function:

```bash
supabase functions deploy policy-embed
```

Or use the combined deployment script:

```bash
./functions/deploy.sh
```

## Usage

### Client-side

Use the `PolicyEmbedder` client utility:

```typescript
import { policyEmbedder } from '@/lib/policy-embedder';

// Generate embeddings for a document
async function embedDocument(documentId) {
  try {
    const embeddedCount = await policyEmbedder.generateEmbeddings(documentId);
    console.log(`Generated embeddings for ${embeddedCount} chunks`);
    
    // Check embedding status
    const status = await policyEmbedder.getEmbeddingStatus(documentId);
    console.log(`Embedding status: ${status.embedded}/${status.total} complete`);
  } catch (error) {
    console.error('Embedding error:', error);
  }
}

// Process and embed in one step
async function processAndEmbed(documentId, filePath) {
  try {
    const result = await policyEmbedder.processAndEmbed(documentId, filePath);
    console.log(`Generated ${result.chunks} chunks with ${result.embeddings} embeddings`);
  } catch (error) {
    console.error('Processing error:', error);
  }
}
```

### Direct API Call

```typescript
const response = await fetch('https://your-project.supabase.co/functions/v1/policy-embed', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${supabaseAccessToken}`
  },
  body: JSON.stringify({
    documentId: 'uuid-of-document'
  })
});

const result = await response.json();
console.log(result);
```

## Security

This function implements several security measures:

1. Authentication check using Supabase Auth
2. RBAC checks - only users with 'administrator' or 'hr_admin' roles can generate embeddings
3. Document ownership verification
4. OpenAI API key protection (server-side only)

## HIPAA Compliance

This function includes considerations for HIPAA compliance:

1. OpenAI Organization ID header is included for organizations with a BAA
2. No sensitive data is logged in function output
3. Data is stored in your Supabase project which should be configured for PHI handling

## Error Handling

The function provides detailed error responses and handles partial success scenarios:

- If all embeddings are generated successfully: 200 OK response
- If some embeddings fail: 207 Multi-Status with details
- If all embeddings fail: 500 Internal Server Error with details

## Batching

Chunks are processed in batches (default: 20 chunks per batch) to avoid OpenAI API rate limits and to handle large documents efficiently. 