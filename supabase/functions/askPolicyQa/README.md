# Policy Q&A Retrieval-Augmented Generation (RAG) Function

This Supabase Edge Function implements a RAG (Retrieval-Augmented Generation) system for answering questions about company policies and procedures.

## Features

- Vector similarity search for finding relevant document chunks
- OpenAI embeddings for query understanding
- Multiple AI models support (OpenAI GPT-4, Claude 3, etc.)
- Source citations for answer traceability
- RBAC for staff-level access control
- HIPAA compliance considerations

## How It Works

1. The function receives a natural language question about company policies
2. It generates an embedding vector for the question using OpenAI API
3. Using pgvector, it finds the most similar document chunks using cosine similarity
4. It retrieves relevant document metadata for citation purposes
5. The function constructs a prompt including the retrieved chunks as context
6. The selected AI model (OpenAI or Anthropic) generates a precise answer based only on the provided context
7. The answer and source citations are returned to the client

## Requirements

This function requires:

1. A Supabase project with pgvector extension enabled
2. The `match_policy_chunks` stored procedure installed
3. A `policy_chunks` table with embeddings generated by the policy-embed function
4. OpenAI API access for embeddings and completions
5. (Optional) Anthropic API access for Claude models

## Supported AI Models

The function supports multiple AI models:

| Model ID | Provider | Description | API Key Required |
|----------|----------|-------------|------------------|
| gpt-4 | OpenAI | Most powerful OpenAI model | OPENAI_API_KEY |
| gpt-3.5-turbo | OpenAI | Fast, cost-effective model | OPENAI_API_KEY |
| claude-3-opus | Anthropic | Most capable Claude model | ANTHROPIC_API_KEY |
| claude-3-sonnet | Anthropic | Balance of intelligence and speed | ANTHROPIC_API_KEY |
| claude-3-haiku | Anthropic | Fastest Claude model | ANTHROPIC_API_KEY |

## Environment Variables

The function requires these environment variables:

```
OPENAI_API_KEY=sk-your-openai-api-key     # Required for embeddings and OpenAI models
OPENAI_ORG_ID=org-your-organization-id    # For BAA/HIPAA compliance (optional)
ANTHROPIC_API_KEY=sk-ant-your-api-key     # Required for Claude models (optional)
```

## Deployment

To deploy this function:

```bash
supabase functions deploy askPolicyQa
```

Or use the combined deployment script:

```bash
./functions/deploy.sh
```

## Usage

### Client-side

Use the `PolicyQA` client utility:

```typescript
import { policyQa } from '@/lib/policy-qa';

// Ask a question about policies
async function askQuestion() {
  try {
    // Default model (gpt-4)
    const result = await policyQa.askQuestion("What is our policy on remote work?");
    
    // Or specify a model
    const claudeResult = await policyQa.askQuestion(
      "What is our policy on remote work?", 
      "claude-3-sonnet"
    );
    
    console.log('Answer:', result.answer);
    console.log('Sources:', result.sources);
    console.log('Model used:', result.model);
    
    // Access full document if needed
    if (result.sources.length > 0) {
      const doc = await policyQa.getDocumentById(result.sources[0].document_id);
      console.log('Full document:', doc);
    }
  } catch (error) {
    console.error('Error asking question:', error);
  }
}
```

### Direct API Call

```typescript
const response = await fetch('https://your-project.supabase.co/functions/v1/askPolicyQa', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${supabaseAccessToken}`
  },
  body: JSON.stringify({
    query: "What is the policy on vacation time?",
    model: "gpt-4" // Optional, defaults to gpt-4
  })
});

const result = await response.json();
console.log(result);
```

## Security

This function implements several security measures:

1. Authentication check using Supabase Auth
2. RBAC allowing only staff roles to access the function
3. API keys protection (server-side only)
4. Input validation to prevent misuse

## Response Format

The function returns responses in this format:

```json
{
  "answer": "According to our policies, employees are entitled to 15 days of paid vacation annually...",
  "sources": [
    {
      "document_id": "uuid-of-document",
      "title": "Employee Handbook",
      "chunk_index": 42,
      "version": "1.2",
      "effective_date": "2023-05-01"
    }
  ],
  "query": "What is the policy on vacation time?",
  "model": "gpt-4"
}
```

## Error Handling

The function provides various error responses:

- 400: Bad Request (missing or invalid query)
- 401: Unauthorized (not authenticated)
- 403: Forbidden (not staff role)
- 500: Internal Server Error (API errors, etc.) 